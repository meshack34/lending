{% extends "base_member.html" %}
{% load humanize %}
{% load json_script %}

{% block member_content %}
<div class="container-fluid py-3">

  <!-- Greeting -->
  <h2 class="mb-4">Welcome back, {{ request.user.username }}</h2>

  <!-- Summary Cards -->
  <div class="row g-3 mb-4">
    <!-- Total Loans -->
    <div class="col-md-3">
      <div class="card shadow-sm border-0">
        <div class="card-body text-center">
          <h6 class="text-muted">Total Loans</h6>
          <h3 class="fw-bold">{{ total_loans }}</h3>
        </div>
      </div>
    </div>
    <!-- Borrowed -->
    <div class="col-md-3">
      <div class="card shadow-sm border-0">
        <div class="card-body text-center">
          <h6 class="text-muted">Borrowed</h6>
          <h3 class="fw-bold text-primary">KSh {{ total_principal|intcomma }}</h3>
        </div>
      </div>
    </div>
    <!-- Repaid -->
    <div class="col-md-3">
      <div class="card shadow-sm border-0">
        <div class="card-body text-center">
          <h6 class="text-muted">Repaid</h6>
          <h3 class="fw-bold text-success">KSh {{ total_repaid|intcomma }}</h3>
        </div>
      </div>
    </div>
    <!-- Outstanding -->
    <div class="col-md-3">
      <div class="card shadow-sm border-0">
        <div class="card-body text-center">
          <h6 class="text-muted">Outstanding</h6>
          <h3 class="fw-bold text-danger">KSh {{ outstanding_balance|intcomma }}</h3>
        </div>
      </div>
    </div>
  </div>

  <!-- Active Loans & Recent Repayments -->
  <div class="row g-3">
    <!-- Active Loans -->
    <div class="col-md-6">
      <div class="card shadow-sm border-0">
        <div class="card-header bg-white"><h5 class="mb-0">Active Loans</h5></div>
        <div class="card-body p-0">
          <table class="table table-hover table-sm mb-0">
            <thead class="table-light">
              <tr><th>ID</th><th>Amount</th><th>Status</th><th>Created</th></tr>
            </thead>
            <tbody>
              {% for loan in active_loans %}
              <tr>
                <td>#{{ loan.id }}</td>
                <td>KSh {{ loan.principal_amount|intcomma }}</td>
                <td><span class="badge bg-info">{{ loan.status }}</span></td>
                <td>{{ loan.created_at|date:"M d, Y" }}</td>
              </tr>
              {% empty %}
              <tr><td colspan="4" class="text-center">No active loans</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Recent Repayments -->
    <div class="col-md-6">
      <div class="card shadow-sm border-0">
        <div class="card-header bg-white"><h5 class="mb-0">Recent Repayments</h5></div>
        <div class="card-body p-0">
          <table class="table table-hover table-sm mb-0">
            <thead class="table-light">
              <tr><th>ID</th><th>Loan</th><th>Amount</th><th>Date</th></tr>
            </thead>
            <tbody>
              {% for r in recent_repayments %}
              <tr>
                <td>#{{ r.id }}</td>
                <td>{{ r.loan.id }}</td>
                <td>KSh {{ r.amount|intcomma }}</td>
                <td>{{ r.paid_at|date:"M d, Y" }}</td>
              </tr>
              {% empty %}
              <tr><td colspan="4" class="text-center">No repayments yet</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Analytics Charts -->
  <div class="row g-3 mt-4">
    <div class="col-md-6">
      <div class="card shadow-sm border-0">
        <div class="card-header bg-white"><h5 class="mb-0">Repayment Trend</h5></div>
        <div class="card-body">
          <canvas id="repaymentChart"></canvas>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card shadow-sm border-0">
        <div class="card-header bg-white"><h5 class="mb-0">Loan Status Breakdown</h5></div>
        <div class="card-body">
          <canvas id="loanChart"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Chart.js -->
{% comment %} Embed data safely as JSON {% endcomment %}
{{ repayment_trend|json_script:"repaymentTrendData" }}
{{ active_loans.count|json_script:"activeLoansCount" }}
{{ closed_loans.count|json_script:"closedLoansCount" }}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const repaymentTrend = JSON.parse(document.getElementById('repaymentTrendData').textContent);
const repaymentLabels = repaymentTrend.map(r => r.month ? new Date(r.month).toLocaleString('default', { month: 'short', year: 'numeric' }) : 'N/A');
const repaymentData = repaymentTrend.map(r => r.total || 0);

const repaymentCtx = document.getElementById('repaymentChart').getContext('2d');
new Chart(repaymentCtx, {
  type: 'line',
  data: {
    labels: repaymentLabels,
    datasets: [{
      label: 'Repayments (KSh)',
      data: repaymentData,
      borderColor: '#007bff',
      backgroundColor: 'rgba(0,123,255,0.1)',
      tension: 0.3,
      fill: true
    }]
  },
  options: {
    responsive: true,
    plugins: { legend: { display: true } },
    scales: { y: { beginAtZero: true } }
  }
});

const loanCtx = document.getElementById('loanChart').getContext('2d');
const activeCount = JSON.parse(document.getElementById('activeLoansCount').textContent);
const closedCount = JSON.parse(document.getElementById('closedLoansCount').textContent);

new Chart(loanCtx, {
  type: 'doughnut',
  data: {
    labels: ['Active', 'Closed'],
    datasets: [{
      data: [activeCount, closedCount],
      backgroundColor: ['#17a2b8', '#28a745']
    }]
  },
  options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
});
</script>
{% endblock %}
